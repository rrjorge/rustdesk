name: Build TECS Remote

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

env:
  CARGO_TERM_COLOR: always
  RUSTDESK_SERVER: ${{ secrets.RUSTDESK_SERVER }}
  RUSTDESK_KEY: ${{ secrets.RUSTDESK_KEY }}
  APP_NAME: ${{ secrets.APP_NAME }}

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: üîß Instalar Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: x86_64-pc-windows-msvc
    
    - name: üì¶ Cache Cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: üì¶ Cache vcpkg
      uses: actions/cache@v3
      with:
        path: |
          C:\vcpkg\installed
          C:\vcpkg\packages
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-
    
    - name: üîß Instalar LLVM
      run: |
        Write-Host "üì• Instalando LLVM..." -ForegroundColor Cyan
        choco install llvm -y
        $env:PATH = "C:\Program Files\LLVM\bin;$env:PATH"
        [Environment]::SetEnvironmentVariable("PATH", $env:PATH, "Machine")
      shell: pwsh
    
    - name: üîß Instalar vcpkg e depend√™ncias
      run: |
        Write-Host "üì¶ Configurando vcpkg..." -ForegroundColor Cyan
        
        if (!(Test-Path "C:\vcpkg")) {
          git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
        }
        
        cd C:\vcpkg
        
        Write-Host "üì¶ Instalando depend√™ncias..." -ForegroundColor Yellow
        .\vcpkg install libvpx:x64-windows-static
        .\vcpkg install libyuv:x64-windows-static  
        .\vcpkg install opus:x64-windows-static
        .\vcpkg install aom:x64-windows-static
        
        $env:VCPKG_ROOT = "C:\vcpkg"
        [Environment]::SetEnvironmentVariable("VCPKG_ROOT", "C:\vcpkg", "Process")
        
        Write-Host "‚úÖ vcpkg configurado!" -ForegroundColor Green
      shell: pwsh
      
    - name: üé® Verificar logo TECS
      run: |
        Write-Host "üîç Verificando logos..." -ForegroundColor Cyan
        
        $logos = @("res/32x32.png", "res/128x128.png", "res/128x128@2x.png", "res/icon.ico")
        $missing = @()
        
        foreach ($logo in $logos) {
          if (Test-Path $logo) {
            Write-Host "  ‚úÖ $logo encontrado" -ForegroundColor Green
          } else {
            Write-Host "  ‚ùå $logo N√ÉO encontrado!" -ForegroundColor Red
            $missing += $logo
          }
        }
        
        if ($missing.Count -gt 0) {
          Write-Host "‚ö†Ô∏è AVISO: Alguns logos n√£o foram encontrados!" -ForegroundColor Yellow
          Write-Host "   Logos faltando: $($missing -join ', ')" -ForegroundColor Yellow
          Write-Host "   Os logos padr√£o do RustDesk ser√£o usados." -ForegroundColor Yellow
        } else {
          Write-Host "‚úÖ Todos os logos TECS encontrados!" -ForegroundColor Green
        }
      shell: pwsh
    
    - name: üìù Converter logo para Base64
      run: |
        Write-Host "üîê Convertendo logo para Base64..." -ForegroundColor Cyan
        
        if (Test-Path "res/128x128.png") {
          $imageBytes = [System.IO.File]::ReadAllBytes("res/128x128.png")
          $base64String = [System.Convert]::ToBase64String($imageBytes)
          $dataUri = "data:image/png;base64,$base64String"
          
          $dataUri | Out-File -FilePath "logo-base64.txt" -Encoding UTF8 -NoNewline
          
          Write-Host "‚úÖ Logo convertido para Base64!" -ForegroundColor Green
        } else {
          Write-Host "‚ö†Ô∏è Logo 128x128.png n√£o encontrado, pulando convers√£o" -ForegroundColor Yellow
          "" | Out-File -FilePath "logo-base64.txt" -Encoding UTF8 -NoNewline
        }
      shell: pwsh
    
    - name: ‚úèÔ∏è Modificar Cargo.toml
      run: |
        Write-Host "‚úèÔ∏è Modificando Cargo.toml..." -ForegroundColor Cyan
        
        $cargoContent = Get-Content "Cargo.toml" -Raw
        
        $cargoContent = $cargoContent -replace 'name\s*=\s*"rustdesk"', 'name = "tecs-remote"'
        $cargoContent = $cargoContent -replace 'default-run\s*=\s*"rustdesk"', 'default-run = "tecs-remote"'
        $cargoContent = $cargoContent -replace 'name\s*=\s*"RustDesk"', 'name = "TECS Remote"'
        $cargoContent = $cargoContent -replace 'identifier\s*=\s*"com\.carriez\.rustdesk"', 'identifier = "br.net.tecs.remote"'
        $cargoContent = $cargoContent -replace 'default\s*=\s*\["use_dasp"\]', 'default = ["use_dasp", "inline"]'
        
        $cargoContent | Out-File -FilePath "Cargo.toml" -Encoding UTF8 -NoNewline
        
        Write-Host "‚úÖ Cargo.toml modificado!" -ForegroundColor Green
      shell: pwsh
    
    - name: ‚úèÔ∏è Modificar config.rs
      run: |
        Write-Host "‚úèÔ∏è Modificando config.rs..." -ForegroundColor Cyan
        
        $configPath = "libs/hbb_common/src/config.rs"
        $configContent = Get-Content $configPath -Raw
        
        $appName = $env:APP_NAME
        if ([string]::IsNullOrEmpty($appName)) { $appName = "TECS Remote" }
        $configContent = $configContent -replace 'APP_NAME:\s*Arc<RwLock<String>>\s*=\s*Arc::new\(RwLock::new\(".*?".to_owned\(\)\)\);', "APP_NAME: Arc<RwLock<String>> = Arc::new(RwLock::new(""$appName"".to_owned()));"
        
        $server = $env:RUSTDESK_SERVER
        if ([string]::IsNullOrEmpty($server)) { 
          Write-Host "‚ö†Ô∏è RUSTDESK_SERVER n√£o configurado!" -ForegroundColor Red
          exit 1
        }
        
        $newServers = "pub const RENDEZVOUS_SERVERS: &'static [&'static str] = &[`n    ""$server:21116""`n];"
        $configContent = $configContent -replace 'pub const RENDEZVOUS_SERVERS:\s*&''static\s*\[&''static str\]\s*=\s*&\[[\s\S]*?\];', $newServers
        
        $key = $env:RUSTDESK_KEY
        if ([string]::IsNullOrEmpty($key)) {
          Write-Host "‚ö†Ô∏è RUSTDESK_KEY n√£o configurado!" -ForegroundColor Red
          exit 1
        }
        $configContent = $configContent -replace 'pub const RS_PUB_KEY:\s*&''static str\s*=\s*"[^"]*";', "pub const RS_PUB_KEY: &'static str = ""$key"";"
        
        if (Test-Path "logo-base64.txt") {
          $base64Logo = Get-Content "logo-base64.txt" -Raw
          
          if (![string]::IsNullOrEmpty($base64Logo)) {
            Write-Host "üé® Aplicando logo TECS em Base64..." -ForegroundColor Cyan
            
            $configContent = $configContent -replace '#\[cfg\(target_os\s*=\s*"macos"\)\]\s*pub const ICON:\s*&str\s*=\s*"[^"]*";', "#[cfg(target_os = ""macos"")]`npub const ICON: &str = ""$base64Logo"";"
            $configContent = $configContent -replace '#\[cfg\(not\(target_os\s*=\s*"macos"\)\)\]\s*pub const ICON:\s*&str\s*=\s*"[^"]*";', "#[cfg(not(target_os = ""macos""))]`npub const ICON: &str = ""$base64Logo"";"
          }
        }
        
        $configContent | Out-File -FilePath $configPath -Encoding UTF8 -NoNewline
        
        Write-Host "‚úÖ config.rs modificado!" -ForegroundColor Green
        Write-Host "   Servidor: $server" -ForegroundColor Gray
        Write-Host "   Key: $($key.Substring(0,20))..." -ForegroundColor Gray
      shell: pwsh
    
    - name: ‚úèÔ∏è Modificar common.rs
      run: |
        Write-Host "‚úèÔ∏è Modificando common.rs..." -ForegroundColor Cyan
        
        $commonPath = "src/common.rs"
        $commonContent = Get-Content $commonPath -Raw
        
        $server = $env:RUSTDESK_SERVER
        $commonContent = $commonContent -replace 'let rendezvous_server\s*=\s*socket_client::get_target_addr\(&format!\(".*?:\{\}",\s*config::RENDEZVOUS_PORT\)\)\?;', "let rendezvous_server = socket_client::get_target_addr(&format!(""$server:{}"", config::RENDEZVOUS_PORT))?;"
        
        $commonContent | Out-File -FilePath $commonPath -Encoding UTF8 -NoNewline
        
        Write-Host "‚úÖ common.rs modificado!" -ForegroundColor Green
      shell: pwsh
    
    - name: ‚úèÔ∏è Modificar main.rs
      run: |
        Write-Host "‚úèÔ∏è Modificando main.rs..." -ForegroundColor Cyan
        
        $mainPath = "src/main.rs"
        $mainContent = Get-Content $mainPath -Raw
        
        $mainContent = $mainContent -replace '//#!\[windows_subsystem\s*=\s*"windows"\]', '#![windows_subsystem = "windows"]'
        
        $mainContent | Out-File -FilePath $mainPath -Encoding UTF8 -NoNewline
        
        Write-Host "‚úÖ main.rs modificado!" -ForegroundColor Green
      shell: pwsh
    
    - name: üî® Compilar UI Resources
      run: |
        Write-Host "üî® Compilando recursos da UI..." -ForegroundColor Cyan
        python res/inline-sciter.py
        Write-Host "‚úÖ Recursos da UI compilados!" -ForegroundColor Green
      shell: pwsh
    
    - name: üèóÔ∏è Build Release
      if: ${{ github.event.inputs.build_type == 'release' }}
      run: |
        Write-Host "üèóÔ∏è Compilando RELEASE..." -ForegroundColor Cyan
        Write-Host "‚è±Ô∏è Isso pode demorar 30-60 minutos..." -ForegroundColor Yellow
        
        $env:VCPKG_ROOT = "C:\vcpkg"
        
        cargo build --release --features inline
        
        Write-Host "‚úÖ Compila√ß√£o RELEASE conclu√≠da!" -ForegroundColor Green
      shell: pwsh
    
    - name: üèóÔ∏è Build Debug
      if: ${{ github.event.inputs.build_type == 'debug' }}
      run: |
        Write-Host "üèóÔ∏è Compilando DEBUG..." -ForegroundColor Cyan
        
        $env:VCPKG_ROOT = "C:\vcpkg"
        
        cargo build --features inline
        
        Write-Host "‚úÖ Compila√ß√£o DEBUG conclu√≠da!" -ForegroundColor Green
      shell: pwsh
    
    - name: üì¶ Verificar execut√°vel
      run: |
        Write-Host "üì¶ Verificando execut√°vel..." -ForegroundColor Cyan
        
        $buildType = "${{ github.event.inputs.build_type }}"
        $exePath = "target/$buildType/tecs-remote.exe"
        
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length / 1MB
          Write-Host "‚úÖ Execut√°vel criado com sucesso!" -ForegroundColor Green
          Write-Host "   Localiza√ß√£o: $exePath" -ForegroundColor Gray
          Write-Host "   Tamanho: $([math]::Round($fileSize, 2)) MB" -ForegroundColor Gray
        } else {
          Write-Host "‚ùå ERRO: Execut√°vel n√£o foi criado!" -ForegroundColor Red
          exit 1
        }
      shell: pwsh
    
    - name: üì§ Upload execut√°vel
      uses: actions/upload-artifact@v3
      with:
        name: tecs-remote-windows-x64-${{ github.event.inputs.build_type }}
        path: target/${{ github.event.inputs.build_type }}/tecs-remote.exe
        retention-days: 30

  
 - name: üìã Criar README
      run: |
        $buildType = "${{ github.event.inputs.build_type }}"
        $readmeContent = "TECS Remote - Build Automatico`n`n"
        $readmeContent += "Build Type: $buildType`n"
        $readmeContent += "Build Date: $(Get-Date -Format 'dd/MM/yyyy HH:mm:ss')`n"
        $readmeContent += "Build Number: ${{ github.run_number }}`n"
        $readmeContent += "Commit: ${{ github.sha }}`n`n"
        $readmeContent += "Configuracoes:`n"
        $readmeContent += "- Servidor: $env:RUSTDESK_SERVER:21116`n"
        $readmeContent += "- Relay: $env:RUSTDESK_SERVER:21117`n"
        $readmeContent += "- App Name: $env:APP_NAME`n"
        $readmeContent += "- Chave Publica: Configurada`n`n"
        $readmeContent += "Arquivos: tecs-remote.exe`n`n"
        $readmeContent += "Proximos Passos:`n"
        $readmeContent += "1. Baixe o artefato`n"
        $readmeContent += "2. Extraia tecs-remote.exe`n"
        $readmeContent += "3. Teste em Windows 10/11`n"
        $readmeContent += "4. Distribua`n`n"
        $readmeContent += "Suporte:`n"
        $readmeContent += "- Email: contato@tecs.net.br`n"
        $readmeContent += "- WhatsApp: (48) 99109-9796`n"
        $readmeContent += "- Site: https://tecs.net.br`n"
        
        $readmeContent | Out-File -FilePath "target/$buildType/README.txt" -Encoding UTF8
      shell: pwsh
