name: Build TECS Remote

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

env:
  CARGO_TERM_COLOR: always
  RUSTDESK_SERVER: ${{ secrets.RUSTDESK_SERVER }}
  RUSTDESK_KEY: ${{ secrets.RUSTDESK_KEY }}
  APP_NAME: ${{ secrets.APP_NAME }}

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Instalar Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: x86_64-pc-windows-msvc
    
    - name: ğŸ“¦ Cache Cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: ğŸ“¦ Cache vcpkg
      uses: actions/cache@v3
      with:
        path: |
          C:\vcpkg\installed
          C:\vcpkg\packages
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-
    
    - name: ğŸ”§ Instalar LLVM
      run: |
        Write-Host "ğŸ“¥ Instalando LLVM..." -ForegroundColor Cyan
        choco install llvm -y
        $env:PATH = "C:\Program Files\LLVM\bin;$env:PATH"
        [Environment]::SetEnvironmentVariable("PATH", $env:PATH, "Machine")
      shell: pwsh
    
    - name: ğŸ”§ Instalar vcpkg e dependÃªncias
      run: |
        Write-Host "ğŸ“¦ Configurando vcpkg..." -ForegroundColor Cyan
        
        # Verificar se vcpkg jÃ¡ existe
        if (!(Test-Path "C:\vcpkg")) {
          git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
        }
        
        cd C:\vcpkg
        
        # Instalar dependÃªncias
        Write-Host "ğŸ“¦ Instalando dependÃªncias..." -ForegroundColor Yellow
        .\vcpkg install libvpx:x64-windows-static
        .\vcpkg install libyuv:x64-windows-static  
        .\vcpkg install opus:x64-windows-static
        .\vcpkg install aom:x64-windows-static
        
        # Configurar variÃ¡vel de ambiente
        $env:VCPKG_ROOT = "C:\vcpkg"
        [Environment]::SetEnvironmentVariable("VCPKG_ROOT", "C:\vcpkg", "Process")
        
        Write-Host "âœ… vcpkg configurado!" -ForegroundColor Green
      shell: pwsh
      
    - name: ğŸ¨ Verificar logo TECS
      run: |
        Write-Host "ğŸ” Verificando logos..." -ForegroundColor Cyan
        
        $logos = @("res/32x32.png", "res/128x128.png", "res/128x128@2x.png", "res/icon.ico")
        $missing = @()
        
        foreach ($logo in $logos) {
          if (Test-Path $logo) {
            Write-Host "  âœ… $logo encontrado" -ForegroundColor Green
          } else {
            Write-Host "  âŒ $logo NÃƒO encontrado!" -ForegroundColor Red
            $missing += $logo
          }
        }
        
        if ($missing.Count -gt 0) {
          Write-Host "âš ï¸ AVISO: Alguns logos nÃ£o foram encontrados!" -ForegroundColor Yellow
          Write-Host "   Logos faltando: $($missing -join ', ')" -ForegroundColor Yellow
          Write-Host "   Os logos padrÃ£o do RustDesk serÃ£o usados." -ForegroundColor Yellow
        } else {
          Write-Host "âœ… Todos os logos TECS encontrados!" -ForegroundColor Green
        }
      shell: pwsh
    
    - name: ğŸ“ Converter logo para Base64
      id: logo_base64
      run: |
        Write-Host "ğŸ” Convertendo logo para Base64..." -ForegroundColor Cyan
        
        if (Test-Path "res/128x128.png") {
          $imageBytes = [System.IO.File]::ReadAllBytes("res/128x128.png")
          $base64String = [System.Convert]::ToBase64String($imageBytes)
          $dataUri = "data:image/png;base64,$base64String"
          
          # Salvar para usar no prÃ³ximo step
          $dataUri | Out-File -FilePath "logo-base64.txt" -Encoding UTF8 -NoNewline
          
          Write-Host "âœ… Logo convertido para Base64!" -ForegroundColor Green
        } else {
          Write-Host "âš ï¸ Logo 128x128.png nÃ£o encontrado, pulando conversÃ£o" -ForegroundColor Yellow
          "" | Out-File -FilePath "logo-base64.txt" -Encoding UTF8 -NoNewline
        }
      shell: pwsh
    
    - name: âœï¸ Modificar Cargo.toml
      run: |
        Write-Host "âœï¸ Modificando Cargo.toml..." -ForegroundColor Cyan
        
        $cargoContent = Get-Content "Cargo.toml" -Raw
        
        # Modificar [package]
        $cargoContent = $cargoContent -replace 'name\s*=\s*"rustdesk"', 'name = "tecs-remote"'
        $cargoContent = $cargoContent -replace 'default-run\s*=\s*"rustdesk"', 'default-run = "tecs-remote"'
        
        # Modificar [package.metadata.bundle]
        $cargoContent = $cargoContent -replace 'name\s*=\s*"RustDesk"', 'name = "TECS Remote"'
        $cargoContent = $cargoContent -replace 'identifier\s*=\s*"com\.carriez\.rustdesk"', 'identifier = "br.net.tecs.remote"'
        
        # Habilitar inline feature
        $cargoContent = $cargoContent -replace 'default\s*=\s*\["use_dasp"\]', 'default = ["use_dasp", "inline"]'
        
        $cargoContent | Out-File -FilePath "Cargo.toml" -Encoding UTF8 -NoNewline
        
        Write-Host "âœ… Cargo.toml modificado!" -ForegroundColor Green
      shell: pwsh
    
    - name: âœï¸ Modificar config.rs
      run: |
        Write-Host "âœï¸ Modificando config.rs..." -ForegroundColor Cyan
        
        $configPath = "libs/hbb_common/src/config.rs"
        $configContent = Get-Content $configPath -Raw
        
        # APP_NAME
        $appName = $env:APP_NAME
        if ([string]::IsNullOrEmpty($appName)) { $appName = "TECS Remote" }
        $configContent = $configContent -replace 'APP_NAME:\s*Arc<RwLock<String>>\s*=\s*Arc::new\(RwLock::new\(".*?".to_owned\(\)\)\);', "APP_NAME: Arc<RwLock<String>> = Arc::new(RwLock::new(`"$appName`".to_owned()));"
        
        # RENDEZVOUS_SERVERS
        $server = $env:RUSTDESK_SERVER
        if ([string]::IsNullOrEmpty($server)) { 
          Write-Host "âš ï¸ RUSTDESK_SERVER nÃ£o configurado!" -ForegroundColor Red
          exit 1
        }
        $newServers = @"
pub const RENDEZVOUS_SERVERS: &'static [&'static str] = &[
"$server`:21116"
];
"@
        $configContent = $configContent -replace 'pub const RENDEZVOUS_SERVERS:\s*&''static\s*\[&''static str\]\s*=\s*&\[[\s\S]*?\];', $newServers
        
        # RS_PUB_KEY
        $key = $env:RUSTDESK_KEY
        if ([string]::IsNullOrEmpty($key)) {
          Write-Host "âš ï¸ RUSTDESK_KEY nÃ£o configurado!" -ForegroundColor Red
          exit 1
        }
        $configContent = $configContent -replace 'pub const RS_PUB_KEY:\s*&''static str\s*=\s*"[^"]*";', "pub const RS_PUB_KEY: &'static str = `"$key`";"
        
        # ICON Base64 (se disponÃ­vel)
        if (Test-Path "logo-base64.txt") {
          $base64Logo = Get-Content "logo-base64.txt" -Raw
          
          if (![string]::IsNullOrEmpty($base64Logo)) {
            Write-Host "ğŸ¨ Aplicando logo TECS em Base64..." -ForegroundColor Cyan
            
            # Substituir ICON para MacOS
            $configContent = $configContent -replace '#\[cfg\(target_os\s*=\s*"macos"\)\]\s*pub const ICON:\s*&str\s*=\s*"[^"]*";', "#[cfg(target_os = `"macos`")]`npub const ICON: &str = `"$base64Logo`";"
            
            # Substituir ICON para outros sistemas
            $configContent = $configContent -replace '#\[cfg\(not\(target_os\s*=\s*"macos"\)\)\]\s*pub const ICON:\s*&str\s*=\s*"[^"]*";', "#[cfg(not(target_os = `"macos`"))]`npub const ICON: &str = `"$base64Logo`";"
          }
        }
        
        $configContent | Out-File -FilePath $configPath -Encoding UTF8 -NoNewline
        
        Write-Host "âœ… config.rs modificado!" -ForegroundColor Green
        Write-Host "   Servidor: $server" -ForegroundColor Gray
        Write-Host "   Key: $($key.Substring(0,20))..." -ForegroundColor Gray
      shell: pwsh
    
    - name: âœï¸ Modificar common.rs
      run: |
        Write-Host "âœï¸ Modificando common.rs..." -ForegroundColor Cyan
        
        $commonPath = "src/common.rs"
        $commonContent = Get-Content $commonPath -Raw
        
        $server = $env:RUSTDESK_SERVER
        $commonContent = $commonContent -replace 'let rendezvous_server\s*=\s*socket_client::get_target_addr\(&format!\(".*?:\{\}",\s*config::RENDEZVOUS_PORT\)\)\?;', "let rendezvous_server = socket_client::get_target_addr(&format!(`"$server`:{}`, config::RENDEZVOUS_PORT))?;"
        
        $commonContent | Out-File -FilePath $commonPath -Encoding UTF8 -NoNewline
        
        Write-Host "âœ… common.rs modificado!" -ForegroundColor Green
      shell: pwsh
    
    - name: âœï¸ Modificar main.rs (ocultar console)
      run: |
        Write-Host "âœï¸ Modificando main.rs..." -ForegroundColor Cyan
        
        $mainPath = "src/main.rs"
        $mainContent = Get-Content $mainPath -Raw
        
        # Descomentar windows_subsystem
        $mainContent = $mainContent -replace '//#!\[windows_subsystem\s*=\s*"windows"\]', '#![windows_subsystem = "windows"]'
        
        $mainContent | Out-File -FilePath $mainPath -Encoding UTF8 -NoNewline
        
        Write-Host "âœ… main.rs modificado (console ocultado)!" -ForegroundColor Green
      shell: pwsh
    
    - name: ğŸ”¨ Compilar UI Resources
      run: |
        Write-Host "ğŸ”¨ Compilando recursos da UI..." -ForegroundColor Cyan
        python res/inline-sciter.py
        Write-Host "âœ… Recursos da UI compilados!" -ForegroundColor Green
      shell: pwsh
    
    - name: ğŸ—ï¸ Build Release
      if: ${{ github.event.inputs.build_type == 'release' }}
      run: |
        Write-Host "ğŸ—ï¸ Compilando RELEASE..." -ForegroundColor Cyan
        Write-Host "â±ï¸ Isso pode demorar 30-60 minutos..." -ForegroundColor Yellow
        
        $env:VCPKG_ROOT = "C:\vcpkg"
        
        cargo build --release --features inline
        
        Write-Host "âœ… CompilaÃ§Ã£o RELEASE concluÃ­da!" -ForegroundColor Green
      shell: pwsh
    
    - name: ğŸ—ï¸ Build Debug
      if: ${{ github.event.inputs.build_type == 'debug' }}
      run: |
        Write-Host "ğŸ—ï¸ Compilando DEBUG..." -ForegroundColor Cyan
        
        $env:VCPKG_ROOT = "C:\vcpkg"
        
        cargo build --features inline
        
        Write-Host "âœ… CompilaÃ§Ã£o DEBUG concluÃ­da!" -ForegroundColor Green
      shell: pwsh
    
    - name: ğŸ“¦ Verificar executÃ¡vel
      run: |
        Write-Host "ğŸ“¦ Verificando executÃ¡vel..." -ForegroundColor Cyan
        
        $buildType = "${{ github.event.inputs.build_type }}"
        $exePath = "target/$buildType/tecs-remote.exe"
        
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length / 1MB
          Write-Host "âœ… ExecutÃ¡vel criado com sucesso!" -ForegroundColor Green
          Write-Host "   LocalizaÃ§Ã£o: $exePath" -ForegroundColor Gray
          Write-Host "   Tamanho: $([math]::Round($fileSize, 2)) MB" -ForegroundColor Gray
        } else {
          Write-Host "âŒ ERRO: ExecutÃ¡vel nÃ£o foi criado!" -ForegroundColor Red
          exit 1
        }
      shell: pwsh
    
    - name: ğŸ“¤ Upload executÃ¡vel
      uses: actions/upload-artifact@v3
      with:
        name: tecs-remote-windows-x64-${{ github.event.inputs.build_type }}
        path: target/${{ github.event.inputs.build_type }}/tecs-remote.exe
        retention-days: 30
    
    - name: ğŸ“‹ Criar README do artefato
      run: |
        $buildType = "${{ github.event.inputs.build_type }}"
        $readme = @"
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              TECS Remote - Build AutomÃ¡tico
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Build Type: $buildType
Build Date: $(Get-Date -Format "dd/MM/yyyy HH:mm:ss")
Build Number: ${{ github.run_number }}
Commit: ${{ github.sha }}

ConfiguraÃ§Ãµes Aplicadas:
- Servidor: $env:RUSTDESK_SERVER:21116
- Relay: $env:RUSTDESK_SERVER:21117
- App Name: $env:APP_NAME
- Chave PÃºblica: Configurada âœ“

Arquivos:
- tecs-remote.exe (ExecutÃ¡vel principal)

PrÃ³ximos Passos:
1. Baixe o artefato do GitHub Actions
2. Extraia tecs-remote.exe
3. Teste em Windows 10/11
4. Distribua para usuÃ¡rios

Suporte:
- Email: contato@tecs.net.br
- WhatsApp: (48) 99109-9796
- Site: https://tecs.net.br

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"@
        $readme | Out-File -FilePath "target/$buildType/README.txt" -Encoding UTF8
      shell: pwsh
    
    - name: ğŸ“¤ Upload README
      uses: actions/upload-artifact@v3
      with:
        name: tecs-remote-windows-x64-${{ github.event.inputs.build_type }}
        path: target/${{ github.event.inputs.build_type }}/README.txt
        retention-days: 30
    
    - name: ğŸ‰ Resumo
      run: |
        Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
        Write-Host "â•‘              âœ… COMPILAÃ‡ÃƒO CONCLUÃDA COM SUCESSO!             â•‘" -ForegroundColor Green
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Green
        
        Write-Host "ğŸ“¦ ARTEFATO GERADO:" -ForegroundColor Cyan
        Write-Host "   Nome: tecs-remote-windows-x64-${{ github.event.inputs.build_type }}" -ForegroundColor White
        Write-Host "   ConteÃºdo:" -ForegroundColor White
        Write-Host "   - tecs-remote.exe" -ForegroundColor Gray
        Write-Host "   - README.txt" -ForegroundColor Gray
        Write-Host ""
        
        Write-Host "ğŸ“¥ COMO BAIXAR:" -ForegroundColor Yellow
        Write-Host "   1. VÃ¡ para aba 'Actions' deste repositÃ³rio" -ForegroundColor White
        Write-Host "   2. Clique neste workflow" -ForegroundColor White
        Write-Host "   3. Role atÃ© 'Artifacts'" -ForegroundColor White
        Write-Host "   4. Baixe 'tecs-remote-windows-x64-${{ github.event.inputs.build_type }}'" -ForegroundColor White
        Write-Host ""
        
        Write-Host "ğŸ§ª PRÃ“XIMOS PASSOS:" -ForegroundColor Cyan
        Write-Host "   1. Baixe e extraia o artefato" -ForegroundColor White
        Write-Host "   2. Execute tecs-remote.exe" -ForegroundColor White
        Write-Host "   3. Verifique logo e configuraÃ§Ãµes" -ForegroundColor White
        Write-Host "   4. Teste conexÃ£o com servidor" -ForegroundColor White
        Write-Host "   5. Distribua para usuÃ¡rios" -ForegroundColor White
        Write-Host ""
      shell: pwsh
